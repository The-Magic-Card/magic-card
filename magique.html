<!DOCTYPE html>
<html lang="fr">
<head>
  <title>The Magic Card - Play</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" href="magic.css">
  <script src="https://cdn.jsdelivr.net/npm/web3@1.6.0/dist/web3.min.js"></script>
</head>
<body>
    <nav>
      <ul>
        <li><a href="index.html">Home</a></li>
        <li><a href="cryptocardm.html"> Win 1 $BNB !</a></li>
        <li><a href="magicmiddlejack.html">Win 5 $BNB !</a></li>
        <li><a href="comingsoon.html">Win 10 BNB !</a></li>
        <li><a href="comingsoon.html">Free Cryptos</a></li>
      </ul>
      <div>
      <button> <a href="faq.html" class="faq-btn2">FAQ</a></button>
        <button class="wallet-btn">Connect Wallet</button>
      </div>
    </nav>
  
    <div class="container" style="display: none;">
      <!-- Tout le contenu du jeu est masqué par défaut -->
      <h1>The Magic Card</h1>
      <div class="game-rules">
        <h2>How to Play</h2>
        <ol>
          <li>Select one or more cards from the grid below.</li>
          <li>Click "Place Bet" to confirm your selection.</li>
          <li>Wait for all grids to be filled.</li>
          <li>If your card is drawn, you win the jackpot!</li>
		  <li>Jackpot send directly to your wallet in 24h!</li>
        </ol>
      </div>
      
      <div class="game-container">
           <div class="game-container">
      <div class="game-info">
        <div class="grids-left">Cards Price: <span id="grids-count">0.01 $BNB</span></div>
      </div>
      
      <div class="game-grid">
        <div class="card" data-id="0"><img alt="Ace of Spades playing card" src="https://deckofcardsapi.com/static/img/AS.png" width="100" height="140"></div>
        <div class="card" data-id="1"><img alt="2 of Spades playing card" src="https://deckofcardsapi.com/static/img/2S.png" width="100" height="140"></div>
        <div class="card" data-id="2"><img alt="3 of Spades playing card" src="https://deckofcardsapi.com/static/img/3S.png" width="100" height="140"></div>
        <div class="card" data-id="3"><img alt="4 of Spades playing card" src="https://deckofcardsapi.com/static/img/4S.png" width="100" height="140"></div>
        <div class="card" data-id="4"><img alt="5 of Spades playing card" src="https://deckofcardsapi.com/static/img/5S.png" width="100" height="140"></div>
        <div class="card" data-id="5" ><img alt="6 of Spades playing card" src="https://deckofcardsapi.com/static/img/6S.png" width="100" height="140"></div>
        <div class="card"data-id="6" ><img alt="7 of Spades playing card" src="https://deckofcardsapi.com/static/img/7S.png" width="100" height="140"></div>
        <div class="card" data-id="7"><img alt="8 of Spades playing card" src="https://deckofcardsapi.com/static/img/8S.png" width="100" height="140"></div>
        <div class="card" data-id="8"><img alt="9 of Spades playing card" src="https://deckofcardsapi.com/static/img/9S.png" width="100" height="140"></div>
        <div class="card" data-id="9"><img alt="10 of Spades playing card" src="https://deckofcardsapi.com/static/img/0S.png" width="100" height="140"></div>
        <div class="card" data-id="10"><img alt="Jack of Spades playing card" src="https://deckofcardsapi.com/static/img/JS.png" width="100" height="140"></div>
        <div class="card" data-id="11"><img alt="Queen of Spades playing card" src="https://deckofcardsapi.com/static/img/QS.png" width="100" height="140"></div>
        <div class="card" data-id="12" ><img alt="King of Spades playing card" src="https://deckofcardsapi.com/static/img/KS.png" width="100" height="140"></div>
        
        <div class="card" data-id="13" ><img alt="Ace of Hearts playing card" src="https://deckofcardsapi.com/static/img/AH.png" width="100" height="140"></div>
        <div class="card" data-id="14"><img alt="2 of Hearts playing card" src="https://deckofcardsapi.com/static/img/2H.png" width="100" height="140"></div>
        <div class="card" data-id="15" ><img alt="3 of Hearts playing card" src="https://deckofcardsapi.com/static/img/3H.png" width="100" height="140"></div>
        <div class="card" data-id="16"><img alt="4 of Hearts playing card" src="https://deckofcardsapi.com/static/img/4H.png" width="100" height="140"></div>
        <div class="card" data-id="17" ><img alt="5 of Hearts playing card" src="https://deckofcardsapi.com/static/img/5H.png" width="100" height="140"></div>
        <div class="card" data-id="18" ><img alt="6 of Hearts playing card" src="https://deckofcardsapi.com/static/img/6H.png" width="100" height="140"></div>
        <div class="card" data-id="19"><img alt="7 of Hearts playing card" src="https://deckofcardsapi.com/static/img/7H.png" width="100" height="140"></div>
        <div class="card" data-id="20"><img alt="8 of Hearts playing card" src="https://deckofcardsapi.com/static/img/8H.png" width="100" height="140"></div>
        <div class="card" data-id="21"><img alt="9 of Hearts playing card" src="https://deckofcardsapi.com/static/img/9H.png" width="100" height="140"></div>
        <div class="card" data-id="22"><img alt="10 of Hearts playing card" src="https://deckofcardsapi.com/static/img/0H.png" width="100" height="140"></div>
        <div class="card" data-id="23"><img alt="Jack of Hearts playing card" src="https://deckofcardsapi.com/static/img/JH.png" width="100" height="140"></div>
        <div class="card" data-id="24"><img alt="Queen of Hearts playing card" src="https://deckofcardsapi.com/static/img/QH.png" width="100" height="140"></div>
        <div class="card" data-id="25"><img alt="King of Hearts playing card" src="https://deckofcardsapi.com/static/img/KH.png" width="100" height="140"></div>
        
        <div class="card" data-id="26"><img alt="Ace of Clubs playing card" src="https://deckofcardsapi.com/static/img/AC.png" width="100" height="140"></div>
        <div class="card" data-id="27"><img alt="2 of Clubs playing card" src="https://deckofcardsapi.com/static/img/2C.png" width="100" height="140"></div>
        <div class="card" data-id="28"><img alt="3 of Clubs playing card" src="https://deckofcardsapi.com/static/img/3C.png" width="100" height="140"></div>
        <div class="card" data-id="29"><img alt="4 of Clubs playing card" src="https://deckofcardsapi.com/static/img/4C.png" width="100" height="140"></div>
        <div class="card" data-id="30"><img alt="5 of Clubs playing card" src="https://deckofcardsapi.com/static/img/5C.png" width="100" height="140"></div>
        <div class="card" data-id="31"><img alt="6 of Clubs playing card" src="https://deckofcardsapi.com/static/img/6C.png" width="100" height="140"></div>
        <div class="card" data-id="32"><img alt="7 of Clubs playing card" src="https://deckofcardsapi.com/static/img/7C.png" width="100" height="140"></div>
        <div class="card" data-id="33"><img alt="8 of Clubs playing card" src="https://deckofcardsapi.com/static/img/8C.png" width="100" height="140"></div>
        <div class="card" data-id="34"><img alt="9 of Clubs playing card" src="https://deckofcardsapi.com/static/img/9C.png" width="100" height="140"></div>
        <div class="card" data-id="35"><img alt="10 of Clubs playing card" src="https://deckofcardsapi.com/static/img/0C.png" width="100" height="140"></div>
        <div class="card" data-id="36"><img alt="Jack of Clubs playing card" src="https://deckofcardsapi.com/static/img/JC.png" width="100" height="140"></div>
        <div class="card" data-id="37"><img alt="Queen of Clubs playing card" src="https://deckofcardsapi.com/static/img/QC.png" width="100" height="140"></div>
        <div class="card" data-id="38"><img alt="King of Clubs playing card" src="https://deckofcardsapi.com/static/img/KC.png" width="100" height="140"></div>
        
        <div class="card" data-id="39"><img alt="Ace of Diamonds playing card" src="https://deckofcardsapi.com/static/img/AD.png" width="100" height="140"></div>
        <div class="card" data-id="40"><img alt="2 of Diamonds playing card" src="https://deckofcardsapi.com/static/img/2D.png" width="100" height="140"></div>
        <div class="card" data-id="41"><img alt="3 of Diamonds playing card" src="https://deckofcardsapi.com/static/img/3D.png" width="100" height="140"></div>
        <div class="card" data-id="42"><img alt="4 of Diamonds playing card" src="https://deckofcardsapi.com/static/img/4D.png" width="100" height="140"></div>
        <div class="card" data-id="43"><img alt="5 of Diamonds playing card" src="https://deckofcardsapi.com/static/img/5D.png" width="100" height="140"></div>
        <div class="card" data-id="44"><img alt="6 of Diamonds playing card" src="https://deckofcardsapi.com/static/img/6D.png" width="100" height="140"></div>
        <div class="card" data-id="45"><img alt="7 of Diamonds playing card" src="https://deckofcardsapi.com/static/img/7D.png" width="100" height="140"></div>
        <div class="card" data-id="46"><img alt="8 of Diamonds playing card" src="https://deckofcardsapi.com/static/img/8D.png" width="100" height="140"></div>
        <div class="card" data-id="47"><img alt="9 of Diamonds playing card" src="https://deckofcardsapi.com/static/img/9D.png" width="100" height="140"></div>
        <div class="card" data-id="48" ><img alt="10 of Diamonds playing card" src="https://deckofcardsapi.com/static/img/0D.png" width="100" height="140"></div>
        <div class="card" data-id="49"><img alt="Jack of Diamonds playing card" src="https://deckofcardsapi.com/static/img/JD.png" width="100" height="140"></div>
        <div class="card" data-id="50"><img alt="Queen of Diamonds playing card" src="https://deckofcardsapi.com/static/img/QD.png" width="100" height="140"></div>
        <div class="card" data-id="51" ><img alt="King of Diamonds playing card" src="https://deckofcardsapi.com/static/img/KD.png" width="100" height="140"></div>
      </div>
      
      <div class="controls">
        <div class="min-bet"> Bet: 0.01 $BNB by card</div>
        <button class="place-bet-btn">Place Bet</button>
      </div>
      
      <div class="total-bet">
        This Game make you win: <span id="total-bet">0.5</span> $BNB Jackpot !
      </div>
      <div class="winner-announcement">
        <h2>The winner is: <span id="winner-name"></span></h2>
      </div>
	  <div class="recent-winners">
          <h2>Recent Winners</h2>
          <ul class="winner-list"></ul>
        </div>
    </div>
  </div>

  <div class="crypto-background">
    <img alt="BNB coin floating icon" src="https://cryptologos.cc/logos/binance-coin-bnb-logo.png" class="crypto-icon" style="width: 50px; left: 5%;">
    <img alt="Bitcoin floating icon" src="https://cryptologos.cc/logos/bitcoin-btc-logo.png" class="crypto-icon" style="width: 40px; left: 25%;">
    <img alt="Ethereum floating icon" src="https://cryptologos.cc/logos/ethereum-eth-logo.png" class="crypto-icon" style="width: 45px; left: 45%;">
    <img alt="Cardano floating icon" src="https://cryptologos.cc/logos/cardano-ada-logo.png" class="crypto-icon" style="width: 35px; left: 65%;">
    <img alt="Polkadot floating icon" src="https://cryptologos.cc/logos/polkadot-new-dot-logo.png" class="crypto-icon" style="width: 30px; left: 85%;">
  </div>
      </div>
    </div>

    <div id="loginPrompt">
      <p>You have to connect MetaMask to play.</p>
    </div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    let web3;
    let contract;
    let selectedCards = [];
    const connectButton = document.querySelector('.wallet-btn');
    const contentContainer = document.querySelector('.container');
    const contractAddress = '0xdc1b1aF820e137361e56D796883284047984aC48';
    const abi =[
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "cardId",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "buyer",
				"type": "address"
			}
		],
		"name": "CardPurchased",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256[]",
				"name": "cardIds",
				"type": "uint256[]"
			}
		],
		"name": "purchaseMultipleCards",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "newPrice",
				"type": "uint256"
			}
		],
		"name": "setCardPrice",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "address",
				"name": "winner",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "cardId",
				"type": "uint256"
			}
		],
		"name": "WinnerSelected",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "cardLocked",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "cardOwners",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "cardPrice",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "getRecentWinners",
		"outputs": [
			{
				"components": [
					{
						"internalType": "address",
						"name": "winnerAddress",
						"type": "address"
					},
					{
						"internalType": "uint256",
						"name": "winningCardId",
						"type": "uint256"
					}
				],
				"internalType": "struct MagicCardGame.Winner[10]",
				"name": "",
				"type": "tuple[10]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "recentWinners",
		"outputs": [
			{
				"internalType": "address",
				"name": "winnerAddress",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "winningCardId",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "totalCardsPurchased",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "winnerIndex",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];

    async function initWeb3() {
        if (window.ethereum) {
            web3 = new Web3(window.ethereum);
            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                contract = new web3.eth.Contract(abi, contractAddress);
                console.log('MetaMask is connected and contract initialized!');
                connectButton.innerText = 'Wallet Connected';
                contentContainer.style.display = 'block';
                updateCardStatus();
                updateRecentWinners();
            } catch (error) {
                console.error('Error connecting to MetaMask:', error);
                alert('Failed to connect MetaMask. ' + error.message);
            }
        } else {
            alert('MetaMask is not installed. Please install it to use this feature.');
        }
    }

    connectButton.addEventListener('click', initWeb3);

    document.querySelector('.game-container').addEventListener('click', function(event) {
        const card = event.target.closest('.card');
        if (card && !card.classList.contains('selected-by-other')) {
            const cardId = parseInt(card.dataset.id, 10);
            toggleCardSelection(card, cardId);
        }
    });

    function toggleCardSelection(cardElement, cardId) {
        cardElement.classList.toggle('selected');
        if (cardElement.classList.contains('selected')) {
            selectedCards.push(cardId);
        } else {
            selectedCards = selectedCards.filter(id => id !== cardId);
        }
    }

    async function calculateGasPrice() {
        const baseGasPrice = await web3.eth.getGasPrice();
        const adjustedGasPrice = web3.utils.toBN(baseGasPrice).mul(web3.utils.toBN(120)).div(web3.utils.toBN(100));
        return adjustedGasPrice.toString();
    }

    document.querySelector('.place-bet-btn').addEventListener('click', async () => {
        if (selectedCards.length === 0) {
            alert('Please select at least one card.');
            return;
        }
        const betAmount = selectedCards.length * 0.01; // 0.01 BNB par carte
        const amountToSend = web3.utils.toWei(betAmount.toString(), 'ether');
        const gasPrice = await calculateGasPrice(); // Calculer le prix du gaz ajusté
        try {
            const accounts = await web3.eth.getAccounts();
            await contract.methods.purchaseMultipleCards(selectedCards).send({
                from: accounts[0],
                value: amountToSend,
                gasPrice: gasPrice
            });
            alert('Transaction successful!');
            selectedCards.forEach(id => {
                const cardElement = document.querySelector(`.card[data-id="${id}"]`);
                cardElement.classList.add('selected-by-other');
                cardElement.classList.remove('selected');
            });
            selectedCards = [];
            updateCardStatus();
        } catch (error) {
            console.error('Transaction failed:', error);
            alert('Transaction failed. See console for details.');
        }
    });

    async function updateCardStatus() {
        const cards = document.querySelectorAll('.card');
        cards.forEach(async (card) => {
            const cardId = parseInt(card.dataset.id, 10);
            const isLocked = await contract.methods.cardLocked(cardId).call();
            card.classList.toggle('selected-by-other', isLocked);
            if (isLocked) {
                card.classList.remove('selected');
            }
        });
    }

    async function updateRecentWinners() {
        const recentWinners = await contract.methods.getRecentWinners().call();
        const winnerList = document.querySelector('.winner-list');
        winnerList.innerHTML = ''; // Clear the existing list
        recentWinners.forEach(winner => {
            if (winner.winnerAddress !== '0x0000000000000000000000000000000000000000') {
                const listItem = document.createElement('li');
                listItem.textContent = `Address: ${winner.winnerAddress}, Card ID: ${winner.winningCardId}`;
                winnerList.appendChild(listItem);
            }
        });
    }

    contract.events.WinnerSelected({}, (error, event) => {
        if (!error) {
            const winnerAddress = event.returnValues.winner;
            const winningCardId = event.returnValues.cardId;
            document.getElementById('winner-name').innerText = winnerAddress;
            updateCardStatus(); // Update card status to make them selectable again
            updateRecentWinners(); // Update the recent winners list
        }
    });

    setInterval(updateCardStatus, 5000);
});


</script>
</body>
</html>

